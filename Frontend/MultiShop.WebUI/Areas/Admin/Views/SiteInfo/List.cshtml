@{
    ViewBag.PageTitle = "Site Bilgileri";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-md-6">
                <h2 class="m-0">@ViewBag.PageTitle</h2>
            </div>
            <div class="col-md-6">
                <a class="btn btn-primary float-right" asp-action="Create">Yeni Site Bilgisi</a>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card card-success card-outline">
                    <div class="card-header with-border clearfix">
                        <h3 class="card-title">@ViewBag.PageTitle</h3>
                    </div>
                    <div class="card-body">
                        <table id="siteinfos-grid" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th class="text-center">#</th>
                                    <th>Kategori</th>
                                    <th class="text-center">İşlem</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section styles {
    @await Html.PartialAsync("Partials/_DataTableStyles")
}

@section scripts {
    @await Html.PartialAsync("Partials/_DataTableScripts")

    <script>
        $(function() {
            $('#siteinfos-grid').DataTable({
                responsive: true,
                lengthChange: false,
                autoWidth: false,
                searching: false,
                ordering: false,
                ajax: {
                    url: '/Admin/SiteInfo/SiteInfoList',
                    type: 'POST',
                },
                columns: [
                    {
                        className: 'dt-control',
                        orderable: false,
                        data: null,
                        defaultContent: '',
                        width: '5%',
                    },
                    {
                        data: null,
                        width: '5%',
                        className: 'text-center',
                        render: function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: 'category',
                    },
                    {
                        data: 'siteInfoId',
                        render: function(data, type, row) {
                            return `
                                <button class="btn btn-sm btn-primary edit-parent" data-id="${data}">Edit</button>
                                <button class="btn btn-outline-danger btn-sm delete-btn" data-id="${data}">Sil</button>
                            `;
                        },
                        width: '15%',
                        className: 'text-center'
                    }
                ],
            });

            $('#siteinfos-grid').on('click', '.edit-parent', function () {
                let btn = $(this);
                let tr = btn.closest('tr');
                let row = $('#siteinfos-grid').DataTable().row(tr);
                let data = row.data();

                let categoryCell = tr.find('td').eq(1);
                categoryCell.attr('contenteditable', true).focus();

                btn.removeClass('edit-parent btn-primary')
                   .addClass('save-parent btn-success')
                   .text('Save');
            });

            function format(items) {
                let html = `<table class="table table-sm child-table"><thead><tr>
                    <th>Info Type</th>
                    <th>Info Value</th>
                    <th>Action</th>
                </tr></thead><tbody>`;

                items.forEach((item, i) => {
                    html += `<tr data-index="${i}">
                        <td contenteditable="true" class="infoType">${item.infoType}</td>
                        <td contenteditable="true" class="infoValue">${item.infoValue}</td>
                        <td><button class="btn btn-sm btn-success save-child">Save</button></td>
                    </tr>`;
                });

                html += `</tbody></table>`;
                return html;
            }

            $('#siteinfos-grid tbody').on('click', 'td.dt-control', function () {
                var tr = $(this).closest('tr');
                var row = $('#siteinfos-grid').DataTable().row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    row.child(format(row.data().items)).show();
                    tr.addClass('shown');
                }
            });
        });
    </script>
}
